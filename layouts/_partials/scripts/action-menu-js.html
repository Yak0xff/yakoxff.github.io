{{ $pageId := . }}
<script defer>
// åˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
function initializeFeatures() {
  const pageId = "{{ $pageId }}";
  console.log(pageId)
  if (!pageId) return;

  // è¯„è®ºå±•å¼€/æ”¶èµ·åŠŸèƒ½
  initializeComments();
  // ç‚¹èµžåŠŸèƒ½
  initializeLikes(pageId);
  // è¯„è®ºæ•°é‡èŽ·å–
  initializeCommentCount();
}

// è¯„è®ºå±•å¼€/æ”¶èµ·åŠŸèƒ½åˆå§‹åŒ–
function initializeComments() {
  const commentsToggle = document.getElementById('comments-toggle');
  const commentsSection = document.getElementById('comments-section');

  if (commentsToggle && commentsSection) {
    commentsToggle.addEventListener('click', function() {
      const isHidden = commentsSection.style.display === 'none';
      commentsSection.style.display = isHidden ? 'block' : 'none';
      this.style.background = isHidden ? 'rgba(0, 0, 0, 0.1)' : 'transparent';
    });
  }
}

// è¯„è®ºæ•°é‡åŠŸèƒ½åˆå§‹åŒ–
function initializeCommentCount() {
  const commentCountEl = document.getElementById('comment-count');
  if (!commentCountEl) return;

  const observer = new MutationObserver(() => {
    const giscusIframe = document.querySelector('iframe.giscus-frame');
    if (giscusIframe) {
      giscusIframe.addEventListener('load', () => {
        window.addEventListener('message', function(event) {
          if (event.origin !== 'https://giscus.app') return;
          const giscusData = event.data;
          if (giscusData.giscus?.discussion) {
            const discussion = giscusData.giscus.discussion;
            const totalComments = (discussion.totalCommentCount || 0) + (discussion.totalReplyCount || 0);
            commentCountEl.textContent = totalComments.toString();
          }
        });
      });
      observer.disconnect();
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });
}

document.addEventListener('DOMContentLoaded', initializeCommentCount);

// ç‚¹èµžåŠŸèƒ½åˆå§‹åŒ–
function initializeLikes(pageId) {
  const elements = {
    count: document.getElementById("like-count-" + pageId),
    btn: document.getElementById("like-btn-" + pageId),
    container: document.getElementById("like-container-" + pageId),
    icon: document.getElementById("like-icon-" + pageId)
  };

  if (!elements.count || !elements.btn || !elements.container) return;

  function updateTooltip() {
    elements.btn.setAttribute('title',
      elements.container.classList.contains('liked')
        ? elements.btn.getAttribute('data-liked-title')
        : 'ä¸ºè¿™ç¯‡æ–‡ç« çŒ®ä¸Šå¿ƒè„'
    );
  }

  function setLikedState() {
    elements.icon?.classList.add('liked-heart');
    elements.icon?.classList.add('animate-heart-beat');
    elements.count?.classList.add('liked-count');
    elements.btn.disabled = true;
    elements.container.classList.add('liked');
    updateTooltip();
  }

  async function fetchLikes() {
    try {
      const response = await fetch("https://like.guhub.cn/like/" + pageId);
      const data = await response.json();
      elements.count.innerText = data.likes ?? 0;
      if (localStorage.getItem("liked_" + pageId)) {
        setLikedState();
      }
    } catch(e) {
      console.log(e);
      elements.count.innerText = "âŒ";
    }
  }

  window.sendLike = async function(pageId) {
    if (localStorage.getItem("liked_" + pageId)) return;

    if (window.location.hostname !== 'localhost' && typeof umami !== 'undefined') {
      umami.track('ðŸ‘ Hit Like Button');
    }

    try {
      const response = await fetch("https://like.guhub.cn/like/" + pageId, { method: "POST" });
      const data = await response.json();
      localStorage.setItem("liked_" + pageId, "1");
      elements.count.innerText = data.likes ?? 1;
      setLikedState();
    } catch(e) {
      console.log(e);
      alert("ç‚¹èµžå¤±è´¥ï¼Œè¯·ç¨åŽå†è¯•");
    }
  };

  fetchLikes();
}

// åœ¨ DOM åŠ è½½å®ŒæˆåŽåˆå§‹åŒ–æ‰€æœ‰åŠŸèƒ½
document.addEventListener('DOMContentLoaded', () => {
  if ('requestIdleCallback' in window) {
    requestIdleCallback(initializeFeatures);
  } else {
    setTimeout(initializeFeatures, 300);
  }
});
</script>
