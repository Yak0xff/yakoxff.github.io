{{ with .Params.comments }}
<!-- Static Comments -->
<div class="my-8">
    <p class="text-secondary">{{ T "postPage.staticCommentsSectionHeader" }}</p>
    {{ range . }}
        <div class="text-xl border-b border-solid border-[#ccc] py-4 px-1">
            <div class="mb-4 flex justify-between">
                <span class="font-bold">{{ .name }}</span>
                <span class="text-secondary">{{ .date }}</span>
            </div>
            <div>
                {{ .content | safeHTML }}
            </div>
            <div class="text-4 text-right text-secondary">
                {{ with .source }}
                <p class="font-mono">{{ T "postPage.originallyPostedOn" . }}</p>
                {{ end }}
            </div>
        </div>
    {{ end }}
</div>
{{ end }}

<!-- email info -->
<!-- <p class="text-size-sm text-secondary">
    *{{ T "emailMe" }} <a href="mailto:{{ .Site.Params.email }}">{{ .Site.Params.email }}</a>
</p> -->

<!-- giscus container -->
<div class="giscus">
    <p style="text-align:center">
        {{ T "postPage.commentNotLoaded" }}
    </p>
</div>

<!-- giscus script -->
<script>
function loadGiscus() {
    if (document.querySelector('iframe.giscus-frame')) return; // 防止重复加载

    const script = document.createElement("script");
    script.src = "https://giscus.app/client.js";
    script.setAttribute("data-repo", "{{ .Site.Params.giscus.repo }}");
    script.setAttribute("data-repo-id", "{{ .Site.Params.giscus.repoId }}");
    script.setAttribute("data-category", "{{ .Site.Params.giscus.category }}");
    script.setAttribute("data-category-id", "{{ .Site.Params.giscus.categoryId }}");
    script.setAttribute("data-mapping", "{{ .Site.Params.giscus.mapping }}");
    script.setAttribute("data-strict", "{{ .Site.Params.giscus.strict }}");
    script.setAttribute("data-reactions-enabled", "{{ .Site.Params.giscus.reactionsEnabled }}");
    script.setAttribute("data-emit-metadata", "1");
    script.setAttribute("data-input-position", "{{ .Site.Params.giscus.inputPosition }}");
    script.setAttribute("data-theme", "{{ .Site.Params.giscus.theme }}");
    script.setAttribute("data-lang", "{{ T "lang" }}");
    script.setAttribute("crossorigin", "anonymous");
    script.async = true;
    document.body.appendChild(script);
    
    // Umami 跟踪：评论区加载
    if (window.umamiTrack) {
        window.umamiTrack('comment-section-loaded', {
            page: window.location.pathname,
            title: document.title
        });
    }
}

const observer = new IntersectionObserver((entries, obs) => {
    if (entries[0].isIntersecting) {
    loadGiscus();
    obs.disconnect();
    }
});

observer.observe(document.getElementById("action-menu"));

// 监听 Giscus 评论事件
window.addEventListener('message', function(event) {
    if (event.origin !== 'https://giscus.app') return;
    
    const giscusData = event.data;
    if (giscusData.giscus) {
        if (window.umamiTrack) {
            // 跟踪评论相关事件
            if (giscusData.giscus.discussion) {
                window.umamiTrack('comment-discussion-loaded', {
                    page: window.location.pathname,
                    discussionId: giscusData.giscus.discussion.id
                });
            }
        }
    }
});
</script>
