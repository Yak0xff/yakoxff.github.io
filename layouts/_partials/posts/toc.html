{{ if and .Params.toc .TableOfContents }}
<aside id="toc-container" class="toc-sidebar">
  <nav id="toc" class="toc-nav">
    <div class="toc-title">目录</div>
    <div class="toc-progress">
      <div class="toc-progress-bar"></div>
    </div>
    <div class="toc-content">
      {{ .TableOfContents }}
    </div>
  </nav>
</aside>

<style>
.toc-sidebar {
  display: none;
  position: fixed;
  top: 50%;
  transform: translateY(-50%);
  right: calc((100vw - var(--page-width)) / 2 - 220px);
  width: 200px;
  max-height: 70vh;
  z-index: 100;
}

@media (min-width: 1200px) {
  .toc-sidebar {
    display: block;
  }
}

@media (min-width: 1400px) {
  .toc-sidebar {
    right: calc((100vw - var(--page-width)) / 2 - 260px);
    width: 240px;
  }
}

.toc-nav {
  position: relative;
}

.toc-title {
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--secondary-text-color);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.75rem;
  padding-left: 0.75rem;
}

.toc-progress {
  position: absolute;
  left: 0;
  top: 2rem;
  bottom: 0;
  width: 2px;
  background: var(--border-color);
  border-radius: 1px;
}

.toc-progress-bar {
  width: 100%;
  background: var(--text-color);
  border-radius: 1px;
  height: 0%;
  transition: height 0.2s ease-out;
}

.toc-content {
  max-height: calc(70vh - 3rem);
  overflow-y: auto;
  padding-left: 0.75rem;
  scrollbar-width: none;
}

.toc-content::-webkit-scrollbar {
  display: none;
}

.toc-content ul {
  list-style: none;
  margin: 0;
  padding: 0;
}

.toc-content li {
  margin: 0;
  padding: 0;
}

.toc-content a {
  display: block;
  padding: 0.35rem 0;
  font-size: 0.8rem;
  line-height: 1.4;
  color: var(--secondary-text-color);
  text-decoration: none;
  transition: color 0.2s, transform 0.2s;
  border-left: 2px solid transparent;
  padding-left: 0.5rem;
  margin-left: -0.75rem;
}

.toc-content a:hover {
  color: var(--text-color);
}

.toc-content a.active {
  color: var(--text-color);
  border-left-color: var(--text-color);
  font-weight: 500;
}

/* Nested levels */
.toc-content ul ul {
  padding-left: 0.75rem;
}

.toc-content ul ul a {
  font-size: 0.75rem;
  opacity: 0.85;
}
</style>

<script>
(function() {
  const tocContainer = document.getElementById('toc-container');
  if (!tocContainer) return;

  const tocContent = tocContainer.querySelector('.toc-content');
  const progressBar = tocContainer.querySelector('.toc-progress-bar');
  const tocLinks = tocContent.querySelectorAll('a');
  const postContent = document.getElementById('post-content');
  
  if (!postContent || tocLinks.length === 0) return;

  // Get all headings from post content
  const headingIds = Array.from(tocLinks).map(link => {
    const href = link.getAttribute('href');
    return href ? href.slice(1) : null;
  }).filter(Boolean);
  
  const headings = headingIds.map(id => document.getElementById(id)).filter(Boolean);
  
  if (headings.length === 0) return;

  let ticking = false;

  function updateTOC() {
    const scrollTop = window.scrollY;
    const windowHeight = window.innerHeight;
    const docHeight = document.documentElement.scrollHeight;
    
    // Update progress bar
    const scrollPercent = Math.min(100, Math.max(0, 
      (scrollTop / (docHeight - windowHeight)) * 100
    ));
    progressBar.style.height = scrollPercent + '%';

    // Find active heading
    let activeIndex = 0;
    const offset = windowHeight * 0.2; // 20% from top
    
    for (let i = 0; i < headings.length; i++) {
      const heading = headings[i];
      const rect = heading.getBoundingClientRect();
      
      if (rect.top <= offset) {
        activeIndex = i;
      } else {
        break;
      }
    }

    // Update active link
    tocLinks.forEach((link, index) => {
      const href = link.getAttribute('href');
      const id = href ? href.slice(1) : null;
      const headingIndex = headingIds.indexOf(id);
      
      if (headingIndex === activeIndex) {
        link.classList.add('active');
        // Scroll TOC to keep active item visible
        const linkRect = link.getBoundingClientRect();
        const containerRect = tocContent.getBoundingClientRect();
        if (linkRect.top < containerRect.top || linkRect.bottom > containerRect.bottom) {
          link.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }
      } else {
        link.classList.remove('active');
      }
    });

    ticking = false;
  }

  function onScroll() {
    if (!ticking) {
      requestAnimationFrame(updateTOC);
      ticking = true;
    }
  }

  // Smooth scroll to heading on click
  tocLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const href = this.getAttribute('href');
      const target = document.querySelector(href);
      if (target) {
        const offset = 80;
        const top = target.getBoundingClientRect().top + window.scrollY - offset;
        window.scrollTo({ top, behavior: 'smooth' });
      }
    });
  });

  window.addEventListener('scroll', onScroll, { passive: true });
  updateTOC(); // Initial update
})();
</script>
{{ end }}
