<!-- Umami Analytics -->
<script>
  if (window.location.hostname !== 'localhost') {
    // 加载 Umami 跟踪脚本
    const script = document.createElement('script');
    script.defer = true;
    script.src = 'https://cloud.umami.is/script.js';
    script.dataset.websiteId = '297a5367-a675-4a3b-a8e7-3b490231e695';
    document.head.appendChild(script);
    
    // 简化的跟踪函数
    window.umamiTrack = function(eventName, eventData = {}) {
      if (typeof umami !== 'undefined') {
        try {
          umami.track(eventName, eventData);
        } catch (e) {
          // 静默处理错误，避免影响用户体验
        }
      }
    };
    
    // 节流函数
    function throttle(func, limit) {
      let inThrottle;
      return function() {
        const args = arguments;
        const context = this;
        if (!inThrottle) {
          func.apply(context, args);
          inThrottle = true;
          setTimeout(() => inThrottle = false, limit);
        }
      }
    }
    
    // 等待 Umami 加载完成后初始化
    script.onload = function() {
      // 优化的滚动跟踪（节流到每2秒最多一次）
      let scrollTracked = false;
      const handleScroll = throttle(function() {
        if (scrollTracked) return;
        
        const scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
        if (scrollPercent >= 75) {
          scrollTracked = true;
          window.umamiTrack('scroll-depth', { depth: '75%' });
        }
      }, 2000);
      
      window.addEventListener('scroll', handleScroll, { passive: true });
      
      // 简化的点击跟踪（使用事件委托）
      document.addEventListener('click', function(e) {
        const link = e.target.closest('a');
        if (!link || !link.href) return;
        
        try {
          const url = new URL(link.href, window.location.origin);
          
          // 外部链接跟踪
          if (url.hostname !== window.location.hostname) {
            window.umamiTrack('external-link', { url: link.href });
            return;
          }
          
          // 文件下载跟踪
          const fileExtensions = /\.(pdf|doc|docx|xls|xlsx|ppt|pptx|zip|rar|7z)$/i;
          if (fileExtensions.test(link.href)) {
            window.umamiTrack('file-download', { type: link.href.split('.').pop() });
          }
        } catch (e) {
          // 忽略 URL 解析错误
        }
      }, { passive: true });
    };
  } else {
    // 本地环境提供空函数
    window.umamiTrack = function() {};
  }
</script>
